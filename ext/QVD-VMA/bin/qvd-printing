#!/usr/bin/perl

use strict;
use warnings;
use 5.010;

use QVD::VMA::Setup;
use QVD::Config::Core;
use QVD::Log;
use URI::Escape qw(uri_escape);

use LWP::Simple;
use Data::Dumper;

my $lpadmin = core_cfg('command.lpadmin');
my $lpstat = core_cfg('command.lpstat');
my $smbclient = core_cfg('command.smbclient');

my %params = @ARGV;

_remove_all_qvd_printers(); # we remove then in every call.

if ($params{'qvd.hook.on_printing'} eq 'connected') {
    my $client_os = $params{'qvd.client.os'};
    my $prt_port = $params{'qvd.printing.port'};

    my $flavor = $params{'qvd.client.printing.flavor'} //
        ($client_os eq 'windows' ? 'cifs' : 'ipp');

    if ($flavor eq 'cifs') {
        if (open my $fh, '-|', $smbclient, -L => '127.0.0.1', -p => $prt_port, '-gN') {
            my %ptrs;
            while (<$fh>) {
                if (my ($target, $desc) = /^Printer\|([^|]+)\|(.*)$/) {
                    $ptrs{$desc} = $target;
                }
            }

            for my $desc (keys %ptrs) {
                my $name = "QVD-$desc";
                $name =~ tr/[A-Za-z0-9\-]/_/c;
                INFO "Registering printer '$name'";
                system($lpadmin,
                       -p => $name,
                       -D => $desc,
                       -v => "smb://LOCALHOST:$ptr_port/".uri_escape($ptrs{$desc}),
                       '-E')
                    and ERROR "Unable to register printer '$desc', lpadmin failed";
            }
        }
        else {
            ERROR "Unable to retrieve printer list, smbclient failed: $!";
        }
    }
    elsif ($flavor eq 'ipp') {
        my $default_set;
        if (open my $fh, '-|', 'lpstat', -h => "127.0.0.1:$prt_port", '-a') {
            if (my ($ptr) = /^(\S+)/) {
                INFO "Registering printer 'QVD-$ptr'";
                if (system($lpadmin,
                           -p => "QVD-$prt",
                           -v => "ipp://127.0.0.1:$prt_port/printers/$prt",
                           '-E') == 0) {
                    # Set the first printer as the default
                    # one. Otherwise the lp tools complain there is
                    # "no default destination available" when trying
                    # to print without specifying a printer. Newer
                    # software using CUPS doesn't seem to care.
                    system($lpadmin, "-d", "QVD-$prt")
                        unless $default_set++;
                }
                else {
                    ERROR "Unable to register printer '$ptr', lpadmin failed: $?";
                }
            }
        }
    }
    elsif ($flavor eq 'slave4') {
    }
}

sub _remove_all_qvd_printers {
    # Remove all QVD printers that might already be configured
    if (open my $fh, '-|', $lpstat, '-a') {
        while (<$fh>) {
            if (my ($ptr) = /^(QVD-\S+)/) {
                INFO "Removing printer $ptr";
                system $lpadmin, -x => $ptr
                    and ERROR "Unable to remove printer '$ptr', lpadmin failed: $?";
            }
        }
    }
    else {
        ERROR "Unable to run lpstat: $!";
    }
}

